--== æœåŠ¡ ==--
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")
local StarterGui = game:GetService("StarterGui")

local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

--== ç™½åå•ç”¨æˆ·ååˆ—è¡¨ ==--
local allowedNames = {
    "YXZM1017",
    "CN_PT6",
    "PT7776", -- ä½ è‡ªå·±
    -- ä½ å¯ä»¥ç»§ç»­æ·»åŠ å…¶ä»–å…è®¸çš„ç”¨æˆ·åï¼Œæ¯”å¦‚ï¼š
    -- "Player2",
    -- "SomeFriend",
}

local function isAllowed(name)
    for _, v in ipairs(allowedNames) do
        if v == name then return true end
    end
    return false
end

if not isAllowed(LocalPlayer.Name) then
    StarterGui:SetCore("SendNotification", {
        Title = "æƒé™æ‹’ç»";
        Text = "æ£€æµ‹åˆ°æœªæˆæƒç”¨æˆ·ï¼Œè¯·è´­ä¹°æ­£ç‰ˆä½¿ç”¨ï¼";
        Duration = 5;
    })
    task.delay(1, function()
        LocalPlayer:Kick("æ£€æµ‹åˆ°æœªæˆæƒç”¨æˆ·ï¼Œè¯·è´­ä¹°æ­£ç‰ˆä½¿ç”¨ï¼")
    end)
    return
end

--== é»˜è®¤å‚æ•° ==--
_G.AIMLOCK_ENABLED = false
_G.HEATVISION_ENABLED = false
_G.SHOW_NAMES = true
_G.SHOW_DISTANCE = true -- æ–°å¢è·ç¦»æ˜¾ç¤ºå¼€å…³
_G.FOV_RADIUS = 100
_G.TEAM_CHECK = true
_G.LOCK_KEY = Enum.UserInputType.MouseButton2

-- é”å®šéƒ¨ä½åˆ—è¡¨
local aimParts = {"Head", "Neck", "LeftHand", "RightHand", "LeftFoot", "RightFoot", "HumanoidRootPart"}
local aimPartIndex = 1
_G.AIM_PART = aimParts[aimPartIndex]

local currentTarget = nil

-- åˆ¤æ–­è§’è‰²æ˜¯å¦æ­»äº¡
local function isDead(character)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not humanoid then return true end
    if humanoid.Health <= 0 then return true end
    return false
end

--== UI åˆ›å»º ==--
local screenGui = Instance.new("ScreenGui", CoreGui)
screenGui.Name = "AimUI"
screenGui.ResetOnSpawn = false

local mainFrame = Instance.new("Frame", screenGui)
mainFrame.Size = UDim2.new(0, 280, 0, 360)
mainFrame.Position = UDim2.new(0, 20, 0.5, -180)
mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
mainFrame.BorderSizePixel = 0
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 8)

local title = Instance.new("TextLabel", mainFrame)
title.Size = UDim2.new(1, 0, 0, 40)
title.BackgroundTransparency = 1
title.Text = "ğŸ¯ Aimlock UI"
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Font = Enum.Font.GothamBold
title.TextSize = 20

--== è‡ªåŠ¨æ’åˆ—æŒ‰é’® ==--
local yOffset = 45
local function createToggle(name, default, callback)
	local toggle = Instance.new("TextButton", mainFrame)
	toggle.Size = UDim2.new(1, -20, 0, 30)
	toggle.Position = UDim2.new(0, 10, 0, yOffset)
	toggle.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
	toggle.Text = name .. ": " .. (default and "ON" or "OFF")
	toggle.TextColor3 = Color3.fromRGB(255, 255, 255)
	toggle.Font = Enum.Font.Gotham
	toggle.TextSize = 16

	yOffset = yOffset + 35
	local state = default
	toggle.MouseButton1Click:Connect(function()
		state = not state
		toggle.Text = name .. ": " .. (state and "ON" or "OFF")
		callback(state)
	end)
end

--== çƒ­æˆåƒé«˜äº® ==--
local function applyHighlight(player)
	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
	if _G.TEAM_CHECK and player.Team == LocalPlayer.Team then return end
	if isDead(player.Character) then return end -- æ–°å¢æ­»äº¡æ£€æµ‹ï¼Œæ­»äº†ä¸é«˜äº®
	if not player.Character:FindFirstChild("HeatVision") then
		local hl = Instance.new("Highlight")
		hl.Name = "HeatVision"
		hl.FillColor = Color3.fromRGB(255, 0, 0)
		hl.OutlineColor = Color3.fromRGB(255, 150, 150)
		hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
		hl.Adornee = player.Character
		hl.Parent = player.Character
	end
end

local function removeHighlight(player)
	if player.Character and player.Character:FindFirstChild("HeatVision") then
		player.Character.HeatVision:Destroy()
	end
end

local function updateHeatVision(state)
	for _, p in ipairs(Players:GetPlayers()) do
		if p ~= LocalPlayer then
			if state then
				applyHighlight(p)
			else
				removeHighlight(p)
			end
		end
	end
end

--== åå­—æ˜¾ç¤º + è·ç¦» ==--
local function updateNames(state)
	for _, player in pairs(Players:GetPlayers()) do
		if player.Character and player.Character:FindFirstChild("Head") then
			local head = player.Character.Head
			if state then
				if not head:FindFirstChild("NameBillboard") then
					local bb = Instance.new("BillboardGui", head)
					bb.Name = "NameBillboard"
					bb.Size = UDim2.new(0, 200, 0, 30)
					bb.StudsOffset = Vector3.new(0, 2, 0)
					bb.AlwaysOnTop = true

					local nameLabel = Instance.new("TextLabel", bb)
					nameLabel.Name = "NameLabel"
					nameLabel.Size = UDim2.new(1, 0, 0, 15)
					nameLabel.Position = UDim2.new(0, 0, 0, 0)
					nameLabel.BackgroundTransparency = 1
					nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
					nameLabel.Text = player.Name
					nameLabel.TextScaled = true
					nameLabel.Font = Enum.Font.Gotham

					local distLabel = Instance.new("TextLabel", bb)
					distLabel.Name = "DistanceLabel"
					distLabel.Size = UDim2.new(1, 0, 0, 15)
					distLabel.Position = UDim2.new(0, 0, 0, 15)
					distLabel.BackgroundTransparency = 1
					distLabel.TextColor3 = Color3.fromRGB(0, 255, 0) -- äº®ç»¿è‰²
					distLabel.TextScaled = true
					distLabel.Font = Enum.Font.Gotham
					distLabel.Text = "..."
				end
			else
				local bb = head:FindFirstChild("NameBillboard")
				if bb then bb:Destroy() end
			end
		end
	end
end

--== æŒ‰é’®åŠŸèƒ½æ·»åŠ  ==--
createToggle("å¯ç”¨è‡ªç„", _G.AIMLOCK_ENABLED, function(val) _G.AIMLOCK_ENABLED = val end)
createToggle("å¼€å¯çƒ­æˆåƒ", _G.HEATVISION_ENABLED, function(val)
	_G.HEATVISION_ENABLED = val
	updateHeatVision(val)
end)
createToggle("æ˜¾ç¤ºç©å®¶å", _G.SHOW_NAMES, function(val)
	_G.SHOW_NAMES = val
	updateNames(val)
end)
createToggle("æ˜¾ç¤ºè·ç¦»", _G.SHOW_DISTANCE, function(val)
	_G.SHOW_DISTANCE = val
end)
createToggle("é˜Ÿä¼æ£€æµ‹", _G.TEAM_CHECK, function(val)
	_G.TEAM_CHECK = val
	updateHeatVision(_G.HEATVISION_ENABLED)
end)

--== é”å®šéƒ¨ä½åˆ‡æ¢æŒ‰é’®ï¼ˆå¾ªç¯åˆ‡æ¢å¤šä¸ªéƒ¨ä½ï¼‰ ==--
local partBtn = Instance.new("TextButton", mainFrame)
partBtn.Size = UDim2.new(1, -20, 0, 30)
partBtn.Position = UDim2.new(0, 10, 0, yOffset)
partBtn.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
partBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
partBtn.Font = Enum.Font.Gotham
partBtn.TextSize = 16
partBtn.Text = "é”å®šéƒ¨ä½: " .. _G.AIM_PART
yOffset = yOffset + 35

partBtn.MouseButton1Click:Connect(function()
	aimPartIndex = aimPartIndex + 1
	if aimPartIndex > #aimParts then aimPartIndex = 1 end
	_G.AIM_PART = aimParts[aimPartIndex]
	partBtn.Text = "é”å®šéƒ¨ä½: " .. _G.AIM_PART
end)

--== éšè— UI æç¤º ==--
local tip = Instance.new("TextLabel", mainFrame)
tip.Size = UDim2.new(1, -20, 0, 20)
tip.Position = UDim2.new(0, 10, 1, -25)
tip.BackgroundTransparency = 1
tip.TextColor3 = Color3.fromRGB(150, 150, 150)
tip.Font = Enum.Font.Gotham
tip.TextSize = 14
tip.Text = "æŒ‰ RightShift éšè—/æ˜¾ç¤º UI"

--== UI æ˜¾ç¤º/éšè—å¿«æ·é”® ==--
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.RightShift then
		mainFrame.Visible = not mainFrame.Visible
	end
end)

--== è‡ªç„é”å®šé€»è¾‘ ==--
RunService.RenderStepped:Connect(function()
	if _G.AIMLOCK_ENABLED and UserInputService:IsMouseButtonPressed(_G.LOCK_KEY) then
		if currentTarget and currentTarget:IsDescendantOf(workspace) then
			-- å†æ¬¡ç¡®è®¤ç›®æ ‡æ²¡æ­»ä¸”ä¸åœ¨é˜Ÿä¼
			local targetCharacter = currentTarget.Parent
			if targetCharacter and not isDead(targetCharacter) then
				if not (_G.TEAM_CHECK and Players:GetPlayerFromCharacter(targetCharacter) and Players:GetPlayerFromCharacter(targetCharacter).Team == LocalPlayer.Team) then
					Camera.CFrame = CFrame.new(Camera.CFrame.Position, currentTarget.Position)
					return
				end
			end
		end

		local shortest = math.huge
		local bestTarget = nil

		for _, player in pairs(Players:GetPlayers()) do
			if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild(_G.AIM_PART) then
				if _G.TEAM_CHECK and player.Team == LocalPlayer.Team then continue end
				if isDead(player.Character) then continue end -- è¿‡æ»¤æ­»äº†çš„ç©å®¶
				local part = player.Character[_G.AIM_PART]
				local screenPos, onScreen = Camera:WorldToViewportPoint(part.Position)
				local dist = (Vector2.new(screenPos.X, screenPos.Y) - UserInputService:GetMouseLocation()).Magnitude

				if onScreen and dist < _G.FOV_RADIUS and dist < shortest then
					shortest = dist
					bestTarget = part
				end
			end
		end

		if bestTarget then
			currentTarget = bestTarget
		else
			currentTarget = nil
		end
	else
		currentTarget = nil
	end
end)

--== å®æ—¶æ›´æ–°è·ç¦»æ˜¾ç¤º ==--
RunService.RenderStepped:Connect(function()
	if not _G.SHOW_NAMES then return end
	for _, player in pairs(Players:GetPlayers()) do
		if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
			local head = player.Character.Head
			local bb = head:FindFirstChild("NameBillboard")
			if bb then
				local distLabel = bb:FindFirstChild("DistanceLabel")
				if distLabel then
					if _G.SHOW_DISTANCE then
						if player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
							local dist = (LocalPlayer.Character.HumanoidRootPart.Position - head.Position).Magnitude
							distLabel.Text = string.format("[%.1f m]", dist)
							distLabel.Visible = true
						else
							distLabel.Visible = false
						end
					else
						distLabel.Visible = false
					end
				end
			end
		end
	end
end)

--== ç©å®¶åŠ å…¥å¤„ç†çƒ­æˆåƒ + åå­—æ˜¾ç¤º ==--
Players.PlayerAdded:Connect(function(p)
	p.CharacterAdded:Connect(function()
		task.wait(1)
		if _G.HEATVISION_ENABLED then applyHighlight(p) end
		if _G.SHOW_NAMES then updateNames(true) end
	end)
end)

--== æ¯10ç§’è‡ªåŠ¨åˆ·æ–°çƒ­æˆåƒ ==--
task.spawn(function()
	while true do
		if _G.HEATVISION_ENABLED then
			for _, p in pairs(Players:GetPlayers()) do
				if p ~= LocalPlayer then
					applyHighlight(p)
				end
			end
		end
		task.wait(10)
	end
end)

--== æŒ‰ W é”®å¼ºåˆ¶åˆ·æ–°çƒ­æˆåƒ ==--
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.W then
		if _G.HEATVISION_ENABLED then
			for _, p in pairs(Players:GetPlayers()) do
				if p ~= LocalPlayer then
					applyHighlight(p)
				end
			end
			print("â™¨ï¸ çƒ­æˆåƒæ‰‹åŠ¨åˆ·æ–°å®Œæˆ")
		end
	end
end)

--== ç½²åæ ‡ç­¾ ==--
local signature = Instance.new("TextLabel", mainFrame)
signature.Size = UDim2.new(1, -20, 0, 20)
signature.Position = UDim2.new(0, 10, 1, -50)
signature.BackgroundTransparency = 1
signature.TextColor3 = Color3.fromRGB(0, 255, 0)  -- ç»¿è‰²
signature.Font = Enum.Font.GothamBold
signature.TextSize = 14
signature.Text = "æœ¬è„šæœ¬ç”±YXZM1017ä¸ªäººå¼€å‘ ç¦æ­¢å€’å–"
signature.TextXAlignment = Enum.TextXAlignment.Center

print("âœ… Aimlock è„šæœ¬åŠ è½½å®Œæˆï¼ˆç™½åå•é™åˆ¶+è·ç¦»æ˜¾ç¤ºé¢œè‰²+å¤šé”å®šéƒ¨ä½+è·ç¦»å¼€å…³+çƒ­æˆåƒè‡ªåŠ¨åˆ·æ–°+æ•Œæˆ‘è¯†åˆ«+æ­»äº¡è¿‡æ»¤ï¼‰")
